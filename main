import pygame
import hero
import morph
import knight
import ground
import os
from pygame import *
from ground import*
from hero import *
from morph import*
from knight import*

height = 600
width = 900
level_amount = 2

FILE_DIR = os.path.dirname(__file__)



def load_level(n, level, morphs,entities,enemies, playerX, playerY):
    c_level = '%s/levels/' + str(n) + '.txt'
    levelfile = open(c_level % FILE_DIR)
    line = " "
    tasks = []
    while line[0] != "/":
        line = levelfile.readline()
        if line[0] == '[':
            line = levelfile.readline()
            while line[0] != "]":
                ending = line.find("|")
                level.append(line[0: ending])
                line = levelfile.readline()
        if line[0] != '':
            charecters = line.split()
            if charecters[0] == 'player':
                playerX = int(charecters[1])
                playerY = int(charecters[2])
            if charecters[0] == 'morph':
                m = Morph(int(charecters[1]), int(charecters[2]))
                entities.add(m)
                morphs.add(m)
            if charecters[0] == 'knight':
                k = Knight(int(charecters[1]), int(charecters[2]))
                entities.add(k)
                enemies.add(k)
    
#ef hero_death():
   #death_image()
def screen_saver():
    pygame.init()
    started = False
    screen = pygame.display.set_mode((width, height))
    pygame.display.set_caption("Obey Dark Lord")
    bg = Surface((width, height))     
    
    background_image=pygame.image.load("screensaver.jpg").convert()
    while not started:
        for e in pygame.event.get():
            if e.type == pygame.KEYDOWN and e.key == pygame.K_SPACE:
                started = True
            screen.blit(background_image, (0,0))
        pygame.display.update()      

def main():
    done = False
    background_image = pygame.image.load("background_1.png").convert()
    
    for i in range(level_amount):
        level = []
        pygame.mixer.music.load(str(i) + '.mp3')
        pygame.mixer.music.play(-1)    
        entities = pygame.sprite.Group()
        grave = [] 
        morphs = pygame.sprite.Group()
        enemies = pygame.sprite.Group()
        ending = pygame.sprite.Group()
        playerX = playerY = 100
        load_level(i + 1, level, morphs,entities, enemies, playerX, playerY)
        hero = Player(playerX,playerY)       
        entities.add(hero)
        x = 0
        y = 0
        for row in level:
            for col in row:
                if col == "-":
                    pf = Ground(x, y)
                    entities.add(pf)
                    grave.append(pf)
                if col == "E":
                    e = LevelEnd(x, y)
                    entities.add(e)
                    ending.add(e)
                x += gr_width
            y += gr_height
            x = 0

        
        timer = pygame.time.Clock()
        left = right = up = 0
        morph_left = morph_right = morph_up = food = 0
        while (not hero.levelcompleted) and (not done):
            timer.tick(30)
            if hero.alive:
                for e in pygame.event.get():
                    if e.type == QUIT: #event handling
                        done = True
                        
                    if e.type == KEYDOWN and e.key == K_UP:#lord behavior
                        up = True
                    if e.type == KEYDOWN and e.key == K_LEFT:
                        left = True
                    if e.type == KEYDOWN and e.key == K_RIGHT:
                        right = True
                    if e.type == KEYUP and e.key == K_UP:
                        up = False
                    if e.type == KEYUP and e.key == K_RIGHT:
                        right = False
                    if e.type == KEYUP and e.key == K_LEFT:
                        left = False    
    
                    if e.type == KEYDOWN and e.key == K_w:#morphs behavior
                        morph_up = True
                    if e.type == KEYDOWN and e.key == K_a:
                        morph_left = True
                    if e.type == KEYDOWN and e.key == K_d:
                        morph_right = True
                    if e.type == KEYUP and e.key == K_w:
                        morph_up = False
                    if e.type == KEYUP and e.key == K_d:
                        morph_right = False
                    if e.type == KEYUP and e.key == K_a:
                        morph_left = False     
                    if e.type == KEYDOWN and e.key == K_e:
                        food = True
                    if e.type == KEYUP and e.key == K_e:
                        food = False                       
                screen.blit(background_image, (0,0))
                for morph in morphs:
                    time.delay(3)
                    morph.update(morph_left, morph_right, morph_up, food, grave, enemies)
                for enemy in enemies:
                    enemy.update(hero, grave)
                hero.update(left, right, up, grave, enemies, ending)
                entities.draw(screen)
                pygame.display.update()
                
                if hero.rect.y > height:
                    hero.alive = False
            else:
                hero.restart()
                for g in grave:
                    g.restart()
                for e in enemies:
                    e.restart()
                for morph in morphs:
                    morph.restart()
        if done:
            pygame.quit()
    pygame.quit()

if __name__ == "__main__":
    pygame.init()
    screen = pygame.display.set_mode((width, height))
    pygame.display.set_caption("Obey Dark Lord")
    bg = Surface((width, height))    
    screen_saver()
    main()        

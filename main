import pygame
import hero
import morph
import ground
import os
from pygame import *
from ground import*
from hero import *
from morph import*

height = 600
width = 900
level_amount = 1

FILE_DIR = os.path.dirname(__file__)



def load_level(n, level):
    c_level = '%s/levels/' + str(n) + '.txt'
    
    levelfile = open(c_level % FILE_DIR)
    line = " "
    tasks = []
    line = levelfile.readline()
    while line[0] != "/":
        line = levelfile.readline()
        if line[0] == '[':
            line = levelfile.readline()
            while line[0] != "]":
                ending = line.find("|")
                level.append(line[0: ending])
                line = levelfile.readline()
    
def screen_saver():
    pygame.init()
    started = False
    screen = pygame.display.set_mode((width, height))
    pygame.display.set_caption("Obey Dark Lord")
    bg = Surface((width, height))     
    
    background_image=pygame.image.load("screensaver.jpg").convert()
    while not started:
        for e in pygame.event.get():
            if e.type == pygame.KEYDOWN and e.key == pygame.K_SPACE:
                started = True
            screen.blit(background_image, (0,0))
        pygame.display.update()      

def main():
    done = False
    background_image = pygame.image.load("background_1.png").convert()
    
    for i in range(level_amount):
        level = []
        load_level(i + 1, level)
        pygame.mixer.music.load(str(i) + '.mp3')
        pygame.mixer.music.play(-1)    
        entities = pygame.sprite.Group()
        grave = [] 
        morphs = pygame.sprite.Group()
        playerX = 200
        playerY = 200
        m1_x = 100
        m1_y = 100
        m_x = 50
        m_y = 50

        x = 0
        y = 0
        for row in level:
            for col in row:
                if col == "-":
                    pf = Ground(x,y)
                    entities.add(pf)
                    grave.append(pf)
                x += gr_width
            y += gr_height
            x = 0
        hero = Player(playerX,playerY)       
        entities.add(hero)
        mor1 = Morph(m1_x, m1_y)
        mor = Morph(m_x, m_y)
        entities.add(mor1)
        entities.add(mor)
        
        morphs.add(mor1)
        morphs.add(mor)
        
        timer = pygame.time.Clock()
        left = right = up = 0
        morph_left = morph_right = morph_up = food = 0
        while not done:
            timer.tick(30)
            for e in pygame.event.get():
                if e.type == QUIT: #event handling
                    done = True
                    
                if e.type == KEYDOWN and e.key == K_UP:#lord behavior
                    up = True
                if e.type == KEYDOWN and e.key == K_LEFT:
                    left = True
                if e.type == KEYDOWN and e.key == K_RIGHT:
                    right = True
                if e.type == KEYUP and e.key == K_UP:
                    up = False
                if e.type == KEYUP and e.key == K_RIGHT:
                    right = False
                if e.type == KEYUP and e.key == K_LEFT:
                    left = False    

                if e.type == KEYDOWN and e.key == K_w:#morphs behavior
                    morph_up = True
                if e.type == KEYDOWN and e.key == K_a:
                    morph_left = True
                if e.type == KEYDOWN and e.key == K_d:
                    morph_right = True
                if e.type == KEYUP and e.key == K_w:
                    morph_up = False
                if e.type == KEYUP and e.key == K_d:
                    morph_right = False
                if e.type == KEYUP and e.key == K_a:
                    morph_left = False                     
            screen.blit(background_image, (0,0))
            for morph in morphs:
                morph.update(morph_left, morph_right, morph_up, food, grave)
            hero.update(left, right, up, grave)
            entities.draw(screen)
            pygame.display.update()

        pygame.quit()

if __name__ == "__main__":
    pygame.init()
    screen = pygame.display.set_mode((width, height))
    pygame.display.set_caption("Obey Dark Lord")
    bg = Surface((width, height))    
    screen_saver()
    main()        
